<!DOCTYPE html>
<html lang="en">
<head>
  <title> CI-TRACS | 3. Deep learning CPU vs GPU </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="utf-8">

  <link rel="stylesheet" href="/css/themes/spacelab/bootstrap.min.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
  <script src="https://kit.fontawesome.com/020726ec0d.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/anchor-js/anchor.min.js"></script>

  <!-- Table of contents -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.css">

  <!-- Load site customizations last -->
  <link rel="stylesheet" href="/css/style.css">

  

  <!-- Load JQuery, then use it to attach the class 'active' to navbar item currently displayed. -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script>
    $(window).on('load', function () {
      $('.nav-item').find('a[href="' + location.pathname + '"]').addClass('active');
    });
  </script>

</head>
<body>

<div class="navbar navbar-expand-lg fixed-top navbar-light bg-light">
  <div class="container">
    <a class="navbar-brand" href="/index.html"> CI-TRACS </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav">
        
        <li class="nav-item"><a class="nav-link" href="/modules/">Modules</a></li>
        
        <li class="nav-item"><a class="nav-link" href="/outcomes/">Outcomes</a></li>
        
        
        <li class="nav-item"><a class="nav-link" href="/readings/">Readings</a></li>
        
        
        <li class="nav-item"><a class="nav-link" href="/experiences/">Experiences</a></li>
        
        
        <li class="nav-item"><a class="nav-link" href="/assessments/">Assessments</a></li>
        
        
      </ul>
    </div>
  </div>
</div>

<!-- Internal fragment for displaying the breadcrumb bar -->
<div class="breadcrumb-background" style="padding-top: 1em; padding-bottom: .01em">
  <div class="container">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        
        <li class="breadcrumb-item"><a href="/">Home</a></li>
        <li class="breadcrumb-item"><a href="/modules">Modules</a></li>
        <li class="breadcrumb-item"><a href="/modules/hpc">High Performance Computing</a></li>
        <li class="breadcrumb-item active">3. Deep learning CPU vs GPU</li>
      </ol>
    </nav>
  </div>
</div>

<div class="js-toc-content">

<div class="container">
  
    <div class="js-toc float-end border border-primary bg-light text-dark p-4 m-4"></div>
  
  <div class="alert alert-success mt-3" role="alert">
  <p><i class="fa-solid fa-globe fa-xl"></i> <strong>Overview</strong></p>
  <hr />

  <p><strong>Questions</strong></p>
  <ul>
    <li>How does the performance of GPU compare with that of CPU?</li>
    <li>How to use Mana to do Machine Learning research?</li>
    <li>How to ask for computing resources?</li>
  </ul>

  <p><strong>Objectives</strong></p>
  <ul>
    <li>Do a basic Deep Learning tutorial on Mana</li>
  </ul>
</div>

<h2 id="review-jupyter-lab-as-an-interactive-application-in-open-ondemand">Review: Jupyter Lab as an Interactive Application in Open OnDemand</h2>

<p>As we previously saw, Open OnDemand allows us to use interactive applications, one of which is Juypter Lab.</p>

<figure>
  
    <img src="/morea/hpc/fig/ood_form.png" style="max-width: 50%;" alt="/Connect%20to%20cluster" class="img-fluid mx-auto d-block" />
  
  <figcaption style="text-align: center">
    <small>
      
    </small>
  </figcaption>
</figure>

<p>The form is used to specify what resources you want, which are then placed into a queue with other waiting jobs and will start to run your job  as soon as the resources requested are available.</p>

<div class="alert alert-info" role="alert">
  <p><i class="fa-solid fa-circle-info fa-xl"></i> <strong>Under the hood</strong></p>
  <hr />

  <p>The Open On Demand form for interactive applications defines a job script and passes it to the HPC systems job scheduler,
taking the burden of how to start the application on the HPC system and how to write a job script that the job scheduler
can understand off of the user.</p>
</div>

<h2 id="activity-learn-to-start-a-session">Activity: Learn to start a session</h2>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>Startup Jupyter Lab and Open Jupyter</strong></p>
  <hr />

  <p>As we will be working in Jupyter Lab to explore some concepts when working with HPC systems and deep learning, your challenge is to start an interactive application of Jupyter Lab with the following parameters:</p>

  <ul>
    <li><strong>Partition:</strong> workshop</li>
    <li><strong>Number of hours:</strong> 3</li>
    <li><strong>Number of Nodes</strong>: 1</li>
    <li><strong>Number of Tasks per Node</strong>: 1</li>
    <li><strong>Number of cores per task:</strong> 4</li>
    <li><strong>GB of Ram:</strong> 24 GB</li>
    <li><strong>Number of GPUs requested:</strong> 1</li>
    <li>
      <p><strong>GPU Type:</strong> Any</p>
    </li>
    <li>Once the interactive session is running Connect to the jupyter session by click the “Connect to Jupyter” button.</li>
  </ul>

  <details>
  <summary>Solution</summary>
<figure>
  
    <img src="/morea/hpc/fig/ood_job.png" style="max-width: 100%;" alt="/Connect%20to%20cluster" class="img-fluid mx-auto d-block" />
  
  <figcaption style="text-align: center">
    <small>
      
    </small>
  </figcaption>
</figure>

</details>
</div>

<h2 id="why-use-jupyter">Why use Jupyter?</h2>

<p>For Python-based data science and machine learning applications, Jupyter notebook is a great platform because:</p>

<ol>
  <li>You can store your data, code, do visualizations, equations, text, outputs all in one place,</li>
  <li>You can easily share your work easily in different formats like JSON, PDF, html,</li>
  <li>It supports more than 40 programming languages, can switch between differnt environments and has an interactive output,</li>
  <li>You can easily edit the code and re-run it without affecting other sections.</li>
</ol>

<h3 id="jupyter-lab-vs-jupyter-notebook">Jupyter Lab vs Jupyter Notebook</h3>

<p>Jupyter notebook allows you to access ipython notebooks only (.ipynb files), i.e. it will create a computational environment which stores your code, results, plots, texts etc. And here you can work in only one of your environments.</p>

<p>Jupyter Lab gives a better user interface along with all the facilties provided by the notebook. It is a flexible, web based application with a modular structure where one can access  python files (.py), ipython notebooks, html or markdown files, access file browser (to upload, download, copy, rename, delete files), work with multiple Jupyter notebooks and environments, all in the same window.</p>

<p>To use Jupyter Lab, You write your code or plain text in rectangular “cells” and the browser then passes it to the back-end “kernel”, which runs your code and returns output.</p>

<div class="alert alert-warning" role="alert">
  <p><i class="fa-solid fa-triangle-exclamation fa-xl"></i> <strong>Heads up: file extensions!</strong></p>
  <hr />

  <p>Note the difference between file extensions: .ipynb file is a python notebook which stores code, text, markdown, plots, results in a specific  format but .py file is a python file which only stores code and plain text (like comments etc).</p>
</div>

<h2 id="how-to-access-and-install-software-and-modules">How to access and install software and modules?</h2>

<h3 id="use-a-package-manager">Use a package manager</h3>

<p>Working with Python requires one to have different packages installed with a specific version which gets updated once in a while. On Mana, there are software packages already installed on the cluster which one can use to install the required libraries, softwares and can even choose which version to install.</p>

<p>You can use following commands to see what modules are available on the cluster or which ones are already loaded or to load a specific module in your environment:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>module avail
module list 
module load &lt;MODULE_NAME&gt;
</code></pre></div></div>

<h3 id="so-what-is-an-environment-then">So what is an environment then?</h3>

<p>Sometimes different applications require different versions of the Python packages than the one you’ve been using and this is where a Python environment comes in handy.</p>

<p>An environment (or a conda environment specifically, which we’ll discuss later) is a directory, specific or isolated to a project, that contains a specific collection of python packages and their different versions that you have installed. There are 2 most popular tools to set up your environment:</p>

<ol>
  <li>
    <p>Pip: a tool to install Python software packages only.</p>
  </li>
  <li>
    <p>Anaconda (or Conda): cross platform package and environment manager which lets you access C, C++ libraries, R package for scientific computing along with Python.</p>
  </li>
</ol>

<div class="alert alert-info" role="alert">
  <p><i class="fa-solid fa-circle-info fa-xl"></i> <strong>Note on packages</strong></p>
  <hr />

  <p>Packages contains all the files you need for the modules it supplies</p>
</div>

<h3 id="the-anaconda-package-manager">The Anaconda package manager</h3>

<p>This is a popular package manager in scientific computing which handles the Python and R programming language related dependencies rather easily. It is preferred more because:</p>

<ul>
  <li>it has a clear directory structure which is easy to understand,</li>
  <li>it allows you to install softwares written in any programming language,</li>
  <li>it gives you a flexibility to create different environments with different software versions (and can install pip packages as well),</li>
  <li>one can use both CLI and GUI.</li>
</ul>

<figure>
  
    <img src="/morea/hpc/fig/Anaconda+Python.png" style="max-width: 50%;" alt="/Anaconda%20+%20Python" class="img-fluid mx-auto d-block" />
  
  <figcaption style="text-align: center">
    <small>
      
    </small>
  </figcaption>
</figure>

<div class="alert alert-info" role="alert">
  <p><i class="fa-solid fa-circle-info fa-xl"></i> <strong>Environment isolation</strong></p>
  <hr />

  <p>If you try to access a library with different version based on your project, pip may throw an error.
To create isolated environments, you can use virtual environment (venv) with pip.</p>
</div>

<h3 id="activity-learn-how-to-setup-an-environment">Activity: Learn how to setup an environment</h3>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>Load Anaconda and libraries</strong></p>
  <hr />

  <p>First, create a conda environment:</p>

  <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>module load lang/Anaconda3
conda create <span class="nt">--name</span> tf2
<span class="nb">source </span>activate tf2
</code></pre></div>  </div>

  <p>Second, install relevant libraries:</p>

  <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>conda <span class="nb">install </span>tensorflow-gpu matplotlib tensorflow keras
</code></pre></div>  </div>
</div>

<h3 id="activity-learn-to-create-a-python-kernel">Activity: Learn to create a Python kernel</h3>

<p>Although we created a conda environment, the Jupyter notebook still cannot access it because “conda” is the directory that contains all the installed conda packages but it is the “kernel” that runs the user’s code and can use and access different conda environments, if required.</p>

<p>A kernel is the computational engine that executes the code contained in Jupyter notebook or it is the interface which tells Jupyter notebook which kernel it should use to access the packages and softwares.</p>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>Create an ipykernel</strong></p>
  <hr />

  <p>Start up a python kernel:</p>

  <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>conda <span class="nb">install </span>ipykernel
python <span class="nt">-m</span> ipykernel <span class="nb">install</span> <span class="nt">--user</span> <span class="nt">--name</span> tf2 <span class="nt">--display-name</span> tf2
</code></pre></div>  </div>
</div>

<h2 id="deep-learning-tutorial">Deep Learning Tutorial</h2>

<p>This is a basic image classification tutorial from CIFAR-10 dataset using TensorFlow.</p>

<div class="alert alert-info" role="alert">
  <p><i class="fa-solid fa-circle-info fa-xl"></i> <strong>About TensorFlow</strong></p>
  <hr />

  <p>TensorFlow is an open source software used in machine learning particularly for training neural networks.</p>

  <p>We’ll define our model using ‘Keras’- a high level API which acts as an interface between TensorFlow
and Python and makes it easy to build and train models. You can read more about it <a href="https://www.tensorflow.org/#">here</a>.</p>
</div>

<h3 id="the-cifar-10-dataset">The CIFAR-10 dataset</h3>

<p>CIFAR-10 is a common dataset used for machine learning and computer vision research. It is a subset of 80 million tiny image dataset and consists of 60,000 images. The images are labelled with 10 different classes. So each class has 5000 training images and 1000 test images. Each row represents a color image of 32 x 32 pixels with 3 channels (RGB).</p>

<figure>
  
    <img src="/morea/hpc/fig/CIFAR-10.jpg" style="max-width: 50%;" alt="/CIFAR" class="img-fluid mx-auto d-block" />
  
  <figcaption style="text-align: center">
    <small>
      
    </small>
  </figcaption>
</figure>

<h3 id="basic-workflow-of-machine-learning">Basic workflow of Machine Learning</h3>

<ol>
  <li>Collect the data</li>
  <li>Pre-process the data</li>
  <li>Define a model</li>
  <li>Train the model</li>
  <li>Evaluate/test the model</li>
  <li>Improve your model</li>
</ol>

<h3 id="activity-work-with-cifar-10-dataset">Activity: Work with CIFAR-10 dataset</h3>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>Import dataset, check configuration</strong></p>
  <hr />

  <p>To start, import all the relevant libraries:</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">keras</span>
<span class="kn">from</span> <span class="nn">keras.datasets</span> <span class="kn">import</span> <span class="n">cifar10</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Conv2D</span><span class="p">,</span> <span class="n">Flatten</span><span class="p">,</span> <span class="n">MaxPooling2D</span><span class="p">,</span> <span class="n">Input</span><span class="p">,</span> <span class="n">InputLayer</span><span class="p">,</span> <span class="n">Dropout</span>
<span class="kn">import</span> <span class="nn">keras.layers.merge</span> <span class="k">as</span> <span class="n">merge</span>
<span class="kn">from</span> <span class="nn">keras.layers.merge</span> <span class="kn">import</span> <span class="n">Concatenate</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.utils</span> <span class="kn">import</span> <span class="n">to_categorical</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.optimizers</span> <span class="kn">import</span> <span class="n">SGD</span><span class="p">,</span> <span class="n">Adam</span>

<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
</code></pre></div>  </div>

  <p>Next, check to see if you’re using the GPU:</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tf</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">list_physical_devices</span><span class="p">(</span><span class="s">'GPU'</span><span class="p">)</span>
</code></pre></div>  </div>

  <p>Now, how would you check to see if you’re using the CPU rather than the GPU?</p>

  <details>
  <summary>Solution</summary>

<pre>
tf.config.list_physical_devices('CPU')
</pre>

</details>
</div>

<div class="alert alert-info" role="alert">
  <p><i class="fa-solid fa-circle-info fa-xl"></i> <strong>Is GPU necessary for machine learning?</strong></p>
  <hr />

  <p>No, machine learning algorithms can be deployed using CPU or GPU, depending on the applications.
They both have their distinct properties and which one would be best for your application depends on
factors like: speed, power usage and cost.</p>

  <p>CPUs are more general purposed processors, are cheaper and
provide a gateway for data to travel from source to GPU cores.</p>

  <p>But GPU have an advantage to do parallel
computing when dealing with large datasets, complex neural network models. The difference between the
two lies in basic features of a processor i.e. cache, clock speed, power consumption, bandwidth and number of cores.</p>

  <p>Read more that <a href="https://thinkml.ai/cpu-vs-gpu-in-machine-learning-algorithms-which-is-better/#">here</a>.</p>
</div>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>Load the data and analyze its shape</strong></p>
  <hr />

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">x_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">)</span> <span class="o">=</span> <span class="n">cifar10</span><span class="p">.</span><span class="n">load_data</span><span class="p">()</span>
<span class="n">nb_classes</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">class_names</span> <span class="o">=</span> <span class="p">[</span><span class="s">'airplane'</span><span class="p">,</span> <span class="s">'automobile'</span><span class="p">,</span> <span class="s">'bird'</span><span class="p">,</span> <span class="s">'cat'</span><span class="p">,</span> <span class="s">'deer'</span><span class="p">,</span> <span class="s">'dog'</span><span class="p">,</span> <span class="s">'frog'</span><span class="p">,</span> <span class="s">'horse'</span><span class="p">,</span> <span class="s">'ship'</span><span class="p">,</span> <span class="s">'truck'</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="s">'Train: X=%s, y=%s'</span> <span class="o">%</span> <span class="p">(</span><span class="n">x_train</span><span class="p">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">y_train</span><span class="p">.</span><span class="n">shape</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">'Test: X=%s, y=%s'</span> <span class="o">%</span> <span class="p">(</span><span class="n">x_valid</span><span class="p">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">.</span><span class="n">shape</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">'number of classes= %s'</span> <span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">y_train</span><span class="p">.</span><span class="n">flatten</span><span class="p">())))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">x_train</span><span class="p">))</span>
</code></pre></div>  </div>

  <details>
  <summary>Solution</summary>

<pre>
Train: X=(50000, 32, 32, 3), y=(50000, 1)
Test: X=(10000, 32, 32, 3), y=(10000, 1)
number of classes= 10
&lt;class 'numpy.ndarray'&gt;
</pre>

</details>
</div>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>Plot some examples</strong></p>
  <hr />

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span> 
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="mi">7</span><span class="p">):</span>
    <span class="c1"># define subplot
</span>    <span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">x_train</span> <span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">class_index</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">y_train</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="n">class_names</span><span class="p">[</span><span class="n">class_index</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
</code></pre></div>  </div>

  <details>
  <summary>Solution</summary>
<figure>
  
    <img src="/morea/hpc/fig/plots.png" style="max-width: 100%;" alt="" class="img-fluid mx-auto d-block" />
  
  <figcaption style="text-align: center">
    <small>
      
    </small>
  </figcaption>
</figure>

</details>
</div>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>Convert data to HDF5 format</strong></p>
  <hr />

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">h5py</span><span class="p">.</span><span class="n">File</span><span class="p">(</span><span class="s">'dataset_cifar10.hdf5'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">hf</span><span class="p">:</span>
    <span class="n">dset_x_train</span> <span class="o">=</span> <span class="n">hf</span><span class="p">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s">'x_train'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">x_train</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">50000</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">compression</span><span class="o">=</span><span class="s">'gzip'</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">dset_y_train</span> <span class="o">=</span> <span class="n">hf</span><span class="p">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s">'y_train'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">50000</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">compression</span><span class="o">=</span><span class="s">'gzip'</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">dset_x_test</span> <span class="o">=</span> <span class="n">hf</span><span class="p">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s">'x_valid'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">x_valid</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">compression</span><span class="o">=</span><span class="s">'gzip'</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">dset_y_test</span> <span class="o">=</span> <span class="n">hf</span><span class="p">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s">'y_valid'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">compression</span><span class="o">=</span><span class="s">'gzip'</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div>  </div>
</div>

<div class="alert alert-info" role="alert">
  <p><i class="fa-solid fa-circle-info fa-xl"></i> <strong>What is an HDF5 file?</strong></p>
  <hr />

  <p>HDF5 file format is a binary data format which is mainly used to store large, heterogenous files. It provides fast, parallel I/O processing.</p>

  <p>You can learn more about it <a href="https://www.hdfgroup.org/solutions/hdf5/#">here</a> and <a href="https://www.christopherlovell.co.uk/blog/2016/04/27/h5py-intro.html#">here</a>.</p>
</div>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>Define the model</strong></p>
  <hr />

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">InputLayer</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">]))</span>

<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s">'same'</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">strides</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">padding</span><span class="o">=</span><span class="s">'same'</span><span class="p">))</span>

<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s">'same'</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">strides</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">padding</span><span class="o">=</span><span class="s">'same'</span><span class="p">))</span>

<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s">'same'</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">strides</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">padding</span><span class="o">=</span><span class="s">'same'</span><span class="p">))</span>

<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s">'same'</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">strides</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">padding</span><span class="o">=</span><span class="s">'same'</span><span class="p">))</span>

<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Flatten</span><span class="p">())</span>

<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">))</span>

<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">))</span>

<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'softmax'</span><span class="p">))</span>

<span class="n">model</span><span class="p">.</span><span class="n">summary</span><span class="p">()</span>
</code></pre></div>  </div>
</div>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>Define the data generator</strong></p>
  <hr />

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">DataGenerator</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">utils</span><span class="p">.</span><span class="n">Sequence</span><span class="p">):</span>
   
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>      
        <span class="n">PATH_TO_FILE</span> <span class="o">=</span> <span class="s">'dataset_cifar10.hdf5'</span>       
        <span class="bp">self</span><span class="p">.</span><span class="n">hf</span> <span class="o">=</span> <span class="n">h5py</span><span class="p">.</span><span class="n">File</span><span class="p">(</span><span class="n">PATH_TO_FILE</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span>         
        <span class="bp">self</span><span class="p">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">test</span> <span class="o">=</span> <span class="n">test</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">on_epoch_end</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">hf</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
       
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">indices</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="p">.</span><span class="n">batch_size</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">batch_size</span> <span class="o">*</span> <span class="n">idx</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">batch_size</span> <span class="o">*</span> <span class="p">(</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>       
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">test</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">hf</span><span class="p">[</span><span class="s">'x_valid'</span><span class="p">][</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">,</span> <span class="p">...]</span>
            <span class="n">batch_x</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">hf</span><span class="p">[</span><span class="s">'y_valid'</span><span class="p">][</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
            <span class="n">batch_y</span> <span class="o">=</span> <span class="n">to_categorical</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">hf</span><span class="p">[</span><span class="s">'x_train'</span><span class="p">][</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">,</span> <span class="p">...]</span>
            <span class="n">batch_x</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">hf</span><span class="p">[</span><span class="s">'y_train'</span><span class="p">][</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
            <span class="n">batch_y</span> <span class="o">=</span> <span class="n">to_categorical</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">batch_x</span><span class="p">,</span> <span class="n">batch_y</span>

    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">test</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">hf</span><span class="p">[</span><span class="s">'x_valid'</span><span class="p">][:].</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">hf</span><span class="p">[</span><span class="s">'x_train'</span><span class="p">][:].</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>          
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">shuffle</span><span class="p">:</span>
            <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">indices</span><span class="p">)</span>
</code></pre></div>  </div>
</div>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>Generate batches of data for training and validation dataset</strong></p>
  <hr />

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">batchsize</span>  <span class="o">=</span> <span class="mi">250</span> 
<span class="n">data_train</span> <span class="o">=</span> <span class="n">DataGenerator</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batchsize</span><span class="p">)</span>
<span class="n">data_valid</span> <span class="o">=</span> <span class="n">DataGenerator</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batchsize</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div>  </div>
</div>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>First, let’s train the model using CPU</strong></p>
  <hr />

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">with</span> <span class="n">tf</span><span class="p">.</span><span class="n">device</span><span class="p">(</span><span class="s">'/device:CPU:0'</span><span class="p">):</span>
    <span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_train</span><span class="p">,</span><span class="n">epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="n">data_valid</span><span class="p">)</span>
</code></pre></div>  </div>
</div>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>Now, let’s compare GPU to CPU performance.</strong></p>
  <hr />

  <p>First, let’s get the CPU performance data.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">clone_model</span>
<span class="n">new_model</span> <span class="o">=</span> <span class="n">clone_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="n">opt</span> <span class="o">=</span> <span class="n">keras</span><span class="p">.</span><span class="n">optimizers</span><span class="p">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
<span class="n">new_model</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s">'categorical_crossentropy'</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s">'accuracy'</span><span class="p">])</span>  
</code></pre></div>  </div>
</div>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>Train the new model with GPU</strong></p>
  <hr />

  <p>Can you do this yourself?</p>

  <details>
  <summary>Solution</summary>

<pre>
with tf.device('/device:GPU:0'):
  new_history = new_model.fit(data_train,epochs=10, verbose=1, validation_data=data_valid)
</pre>
</details>
</div>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>Plot the losses and accuracy for training and validation set</strong></p>
  <hr />

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">.</span><span class="n">history</span><span class="p">[</span><span class="s">'loss'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s">'train_loss'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">.</span><span class="n">history</span><span class="p">[</span><span class="s">'val_loss'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s">'val_loss'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">set_title</span><span class="p">(</span><span class="s">'Loss'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">grid</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">.</span><span class="n">history</span><span class="p">[</span><span class="s">'accuracy'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s">'train_acc'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">.</span><span class="n">history</span><span class="p">[</span><span class="s">'val_accuracy'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s">'val_acc'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">set_title</span><span class="p">(</span><span class="s">'Accuracy'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">grid</span><span class="p">()</span>
</code></pre></div>  </div>

  <details>
  <summary>Solution</summary>
<figure>
  
    <img src="/morea/hpc/fig/grahs.png" style="max-width: 100%;" alt="" class="img-fluid mx-auto d-block" />
  
  <figcaption style="text-align: center">
    <small>
      
    </small>
  </figcaption>
</figure>

</details>
</div>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>Evaluate the model and make predictions</strong></p>
  <hr />

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">x</span> <span class="o">=</span> <span class="n">x_valid</span><span class="p">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">to_categorical</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">score</span> <span class="o">=</span> <span class="n">new_model</span><span class="p">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'Test cross-entropy loss: %0.5f'</span> <span class="o">%</span> <span class="n">score</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="s">'Test accuracy: %0.2f'</span> <span class="o">%</span> <span class="n">score</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">y_pred</span> <span class="o">=</span> <span class="n">new_model</span><span class="p">.</span><span class="n">predict_classes</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</code></pre></div>  </div>
</div>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>Plot the predictions</strong></p>
  <hr />

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span> 
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reshape</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">index1</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="s">"y: %s</span><span class="se">\n</span><span class="s">p: %s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">class_names</span><span class="p">[</span><span class="n">index1</span><span class="p">],</span> <span class="n">class_names</span><span class="p">[</span><span class="n">y_pred</span><span class="p">[</span><span class="n">i</span><span class="p">]]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s">'left'</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
</code></pre></div>  </div>

  <details>
  <summary>Solution</summary>
<figure>
  
    <img src="/morea/hpc/fig/predictions.png" style="max-width: 100%;" alt="" class="img-fluid mx-auto d-block" />
  
  <figcaption style="text-align: center">
    <small>
      
    </small>
  </figcaption>
</figure>

</details>
</div>

<h2 id="other-resources-to-do-machine-learning">Other resources to do Machine Learning</h2>

<ul>
  <li>You can use <a href="https://colab.research.google.com/#">Google Colab</a> which uses Jupyter notebooks too but on Google server. Here you can get free limited compute resources (even GPU) and upgrade your account (for TPU) if you want more. The code usually runs on Google servers on cloud and is connected to your google account so all your projects will be saved in your Google Drive.</li>
  <li>Microsoft <a href="https://visualstudio.microsoft.com/vs/features/notebooks-at-microsoft/#">Azure notebook</a> is similar to Google Colab with cloud sharing functionality but provides more memory.</li>
  <li>Kaggle</li>
  <li>Amazon Sage Maker</li>
</ul>

<h2 id="discussion">Discussion</h2>

<div class="alert alert-secondary" role="alert">
  <p><i class="fa-solid fa-user-pen fa-xl"></i>  <strong>Why HPC?</strong></p>
  <hr />

  <p>Why would you need an HPC cluster over your personal computer?</p>

</div>

<h2 id="key-points">Key Points</h2>

<div class="alert alert-success" role="alert">

  <ul>
    <li>Open On Demand requires you have a strong, stable internet connection whereas SSH can work with weak connections too.</li>
    <li>JupyterLab is a more common platform for data science research but there are other IDE (Integrated Development Environment softwares) like PyCharm, Spyder, RMarkdown too.</li>
    <li>Using multiple GPUs won’t improve the performance of your machine learning model. It only helps for a very complex computation or large models.</li>
  </ul>
</div>

<hr />

<p>For comparison purposes, here’s the <a href="https://ci-tracs.github.io/High_Performance_Computing/11-hpc-deep-learning/index.html">Software Carpentry version of this page</a></p>

</div>

</div>


<!-- Maybe find a different way?
<script src="/js/scrollIfAnchor.js"></script>
-->

<footer class="footer footer-background" style="padding-top: 1em; padding-bottom: 1em">
  <div class="container text-center">
    
    <p>Philip Johnson | Information and Computer Sciences | University of Hawaii <br />
johnson@hawaii.edu<br /></p>


    
    <p style="margin: 0">Powered by the <a class="footer-link" href="http://morea-framework.github.io/">Morea Framework</a> (Theme: spacelab)<br>
      Last update on: <span>2022-07-20 09:55:49 -1000</span></p>

    <p style="margin: 0">
      
      4 modules
      
      | 4 outcomes
      
      
      | 7 readings
      
      
      | 12 experiences
      
      
      | 4 assessments
      
    </p>
  </div>
</footer>


<!-- Load Bootstrap JavaScript components -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>


<script type="text/javascript" async
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-MML-AM_CHTML">
</script>


<!-- Add anchors to pages. -->
<script>
  anchors.add();
</script>

<script>
  tocbot.init({
    headingsOffset: 70,
    scrollSmoothOffset: -70,
    collapseDepth: 6,
  });
</script>




</body>
</html>
